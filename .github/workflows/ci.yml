name: CI

on:
  schedule:
    # ë§¤ì¼ 11:00 UTC (KST 20:00)
    - cron: "0 11 * * *"
    # ë§¤ì¼ 23:00 UTC (KST 08:00+1)
    - cron: "0 23 * * *"
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ì§€ì›
  pull_request:
  push:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 10
    strategy:
      matrix:
        skill: [humanizer, grammar-checker]
      fail-fast: false  # í•œ ìŠ¤í‚¬ì´ ì‹¤íŒ¨í•´ë„ ë‹¤ë¥¸ ìŠ¤í‚¬ í…ŒìŠ¤íŠ¸ ê³„ì†

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Validate SKILL.md frontmatter
        run: |
          echo "ğŸ“ Validating YAML frontmatter for ${{ matrix.skill }}..."
          SKILL_FILE="skills/${{ matrix.skill }}/SKILL.md"

          if [ ! -f "$SKILL_FILE" ]; then
            echo "âŒ SKILL.md not found"
            exit 1
          fi

          # Extract frontmatter (between --- markers)
          FRONTMATTER=$(sed -n '/^---$/,/^---$/p' "$SKILL_FILE" | sed '1d;$d')

          # Check required field: name
          if echo "$FRONTMATTER" | grep -q "^name:"; then
            NAME=$(echo "$FRONTMATTER" | grep "^name:" | sed 's/name: *//')
            echo "âœ… Found name: $NAME"

            # Verify name matches matrix skill
            if [ "$NAME" = "${{ matrix.skill }}" ]; then
              echo "âœ… Name is correct: ${{ matrix.skill }}"
            else
              echo "âŒ Name should be '${{ matrix.skill }}', got '$NAME'"
              exit 1
            fi
          else
            echo "âŒ Missing required field: name"
            exit 1
          fi

          # Check required field: description
          if echo "$FRONTMATTER" | grep -q "^description:"; then
            # Handle both quoted and unquoted descriptions
            DESC=$(echo "$FRONTMATTER" | sed -n 's/^description: *"\?\(.*\)"\?$/\1/p')
            DESC_LEN=${#DESC}
            echo "âœ… Found description ($DESC_LEN chars)"

            # Verify description length (1-1024 chars per Agent Skills spec)
            if [ $DESC_LEN -lt 1 ] || [ $DESC_LEN -gt 1024 ]; then
              echo "âŒ Description must be 1-1024 characters, got $DESC_LEN"
              exit 1
            fi

            # Check for non-ASCII characters in description (CLI compatibility)
            if echo "$DESC" | grep -qP '[^\x00-\x7F]'; then
              echo "âš ï¸  Warning: Description contains non-ASCII characters (may cause CLI parsing issues)"
            else
              echo "âœ… Description is ASCII-safe"
            fi
          else
            echo "âŒ Missing required field: description"
            exit 1
          fi

          echo "âœ… Frontmatter validation passed for ${{ matrix.skill }}"

      - name: Validate skill structure
        run: |
          echo "ğŸ“ Validating skill structure for ${{ matrix.skill }}..."
          SKILL_DIR="skills/${{ matrix.skill }}"

          # Check SKILL.md exists
          if [ ! -f "$SKILL_DIR/SKILL.md" ]; then
            echo "âŒ SKILL.md not found"
            exit 1
          fi
          echo "âœ… SKILL.md exists"

          # Check for references directory (if it exists)
          if [ -d "$SKILL_DIR/references" ]; then
            echo "âœ… references/ directory found"
            REF_COUNT=$(find "$SKILL_DIR/references" -name "*.md" | wc -l)
            echo "   Found $REF_COUNT reference files"
          fi

          # Check for examples directory (if it exists)
          if [ -d "$SKILL_DIR/examples" ]; then
            echo "âœ… examples/ directory found"
            EX_COUNT=$(find "$SKILL_DIR/examples" -type f | wc -l)
            echo "   Found $EX_COUNT example files"
          fi

          # Check for scripts directory (if it exists)
          if [ -d "$SKILL_DIR/scripts" ]; then
            echo "âœ… scripts/ directory found"
            SCRIPT_COUNT=$(find "$SKILL_DIR/scripts" -type f | wc -l)
            echo "   Found $SCRIPT_COUNT scripts"
          fi

          # Check for assets directory (if it exists)
          if [ -d "$SKILL_DIR/assets" ]; then
            echo "âœ… assets/ directory found"
            ASSET_COUNT=$(find "$SKILL_DIR/assets" -type f | wc -l)
            echo "   Found $ASSET_COUNT assets"
          fi

          echo "âœ… Skill structure validation passed for ${{ matrix.skill }}"

      - name: Validate skill-specific requirements
        run: |
          echo "ğŸ” Running skill-specific validation for ${{ matrix.skill }}..."

          if [ "${{ matrix.skill }}" = "humanizer" ]; then
            echo "Validating humanizer-specific files..."

            # Expected reference files for humanizer
            EXPECTED_FILES=(
              "skills/humanizer/references/punctuation-patterns.md"
              "skills/humanizer/references/spacing-patterns.md"
              "skills/humanizer/references/pos-patterns.md"
              "skills/humanizer/references/vocabulary-patterns.md"
              "skills/humanizer/references/structure-patterns.md"
            )

            for file in "${EXPECTED_FILES[@]}"; do
              if [ -f "$file" ]; then
                echo "âœ… Found: $file"
              else
                echo "âŒ Missing: $file"
                exit 1
              fi
            done

          elif [ "${{ matrix.skill }}" = "grammar-checker" ]; then
            echo "Validating grammar-checker-specific files..."

            # Expected reference files for grammar-checker
            EXPECTED_FILES=(
              "skills/grammar-checker/references/rules.md"
              "skills/grammar-checker/references/common-errors.md"
            )

            for file in "${EXPECTED_FILES[@]}"; do
              if [ -f "$file" ]; then
                echo "âœ… Found: $file"
              else
                echo "âŒ Missing: $file"
                exit 1
              fi
            done
          fi

          echo "âœ… Skill-specific validation passed for ${{ matrix.skill }}"

      - name: Install skill with npx skills add
        run: |
          echo "ğŸ§ª Installing ${{ matrix.skill }} with npx skills add..."

          # Install skill with claude-code agent and auto-confirm
          npx skills add DaleSeo/korean-skills --skill ${{ matrix.skill }} --agent claude-code --yes || {
            echo "âš ï¸  npx skills add failed, but continuing to verify..."
            echo "This may be expected in CI environment due to TTY issues"
          }

          echo "âœ… Skill installation step completed for ${{ matrix.skill }}"

      - name: Verify installed skill
        run: |
          echo "ğŸ” Verifying installed ${{ matrix.skill }}..."

          # Debug: Show all potential skill locations
          echo "ğŸ” Searching for skill installation..."
          echo "Checking ~/.claude/skills/:"
          ls -laR ~/.claude/ 2>/dev/null || echo "~/.claude/ not found"

          echo ""
          echo "Checking ~/.agents/skills/:"
          ls -laR ~/.agents/ 2>/dev/null || echo "~/.agents/ not found"

          echo ""
          echo "Searching entire home directory for ${{ matrix.skill }}:"
          find ~ -name "${{ matrix.skill }}" -type d 2>/dev/null | head -10 || echo "No directories found"

          # Try to find the skill in any location
          SKILL_DIR=""
          if [ -d ~/.claude/skills/${{ matrix.skill }} ]; then
            SKILL_DIR=~/.claude/skills/${{ matrix.skill }}
          elif [ -d ~/.agents/skills/${{ matrix.skill }} ]; then
            SKILL_DIR=~/.agents/skills/${{ matrix.skill }}
          else
            # Last resort: search for it
            SKILL_DIR=$(find ~ -name "${{ matrix.skill }}" -type d 2>/dev/null | grep -E '(\.claude|\.agents)/skills' | head -1)
          fi

          if [ -z "$SKILL_DIR" ]; then
            echo "âŒ Skill directory not found in any expected location"
            echo "This may indicate npx skills add failed to install"
            exit 1
          fi

          echo "âœ… Skill directory found: $SKILL_DIR"
          echo "ğŸ“ Contents:"
          ls -la "$SKILL_DIR"

          # Find and display SKILL.md content
          echo ""
          echo "ğŸ“„ Searching for SKILL.md..."
          SKILL_FILE=$(find "$SKILL_DIR" -name "*.md" -type f | head -1)

          if [ -z "$SKILL_FILE" ]; then
            echo "âŒ No .md files found in skill directory"
            exit 1
          fi

          echo "âœ… Found skill file: $SKILL_FILE"
          echo "ğŸ“‹ Skill content preview:"
          head -20 "$SKILL_FILE"

          # Verify references directory (if expected)
          echo ""
          if [ -d "$SKILL_DIR/references" ]; then
            echo "âœ… references/ directory installed"
            echo "ğŸ“š Reference files:"
            ls -1 "$SKILL_DIR/references/"
          else
            echo "â„¹ï¸  references/ directory not found (may not be required)"
          fi

          echo "âœ… Skill verification completed for ${{ matrix.skill }}"

  summary:
    runs-on: ubuntu-latest
    needs: test
    if: always()
    steps:
      - name: Check test results
        run: |
          echo "ğŸ“Š Test Summary"
          echo "==============="
          if [ "${{ needs.test.result }}" = "success" ]; then
            echo "âœ… All skill tests passed!"
            exit 0
          else
            echo "âŒ Some skill tests failed"
            exit 1
          fi
